<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­—åŒ–ç›‘æ§é¢æ¿ v2.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0a0e17;
            --card-bg: rgba(30, 41, 59, 0.6);
            --text-primary: #e0e6ed;
            --text-secondary: #94a3b8;
            --accent-blue: #3498db;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
            --accent-yellow: #f1c40f;
        }
        body {
            margin: 0;
            font-family: 'Segoe UI', Roboto, monospace;
            background-color: var(--bg-color);
            background-image: 
                linear-gradient(rgba(52, 152, 219, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(52, 152, 219, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 30px; background: rgba(15, 23, 42, 0.9);
            border-bottom: 1px solid rgba(52, 152, 219, 0.3); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
        }
        .brand { font-size: 1.5rem; font-weight: bold; color: var(--accent-blue); letter-spacing: 2px; }
        .user-info { display: flex; align-items: center; gap: 20px; }
        .btn-logout { padding: 8px 15px; border: 1px solid var(--accent-red); color: var(--accent-red); text-decoration: none; border-radius: 4px; font-size: 14px; transition: all 0.3s; }
        .btn-logout:hover { background: var(--accent-red); color: white; }

        /* ä¸»å†…å®¹åŒº */
        .container { padding: 30px; max-width: 1400px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 25px; }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--card-bg); padding: 25px; border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            transition: transform 0.3s, border-color 0.3s, box-shadow 0.3s;
            position: relative; overflow: hidden;
            cursor: pointer; /* é¼ æ ‡å˜æ‰‹å‹ */
        }
        .card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, var(--accent-blue), transparent); opacity: 0.5;
        }
        .card:hover { transform: translateY(-5px); border-color: var(--accent-blue); box-shadow: 0 10px 20px rgba(52, 152, 219, 0.2); }
        .card.offline-card { border-color: var(--accent-red); opacity: 0.8; cursor: default; }
        .card.offline-card::before { background: var(--accent-red); }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .hostname { font-size: 1.3rem; font-weight: bold; letter-spacing: 1px; }
        .status-indicator { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; }
        .status-online { background: rgba(46, 204, 113, 0.2); color: var(--accent-green); box-shadow: 0 0 10px rgba(46, 204, 113, 0.3); }
        .status-offline { background: rgba(231, 76, 60, 0.2); color: var(--accent-red); box-shadow: 0 0 10px rgba(231, 76, 60, 0.3); }

        .stat-row { margin-bottom: 12px; }
        .stat-info { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; color: var(--text-secondary); }
        .progress-bg { height: 8px; background: rgba(0, 0, 0, 0.3); border-radius: 4px; overflow: hidden; }
        .progress-bar { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        
        .click-hint { font-size: 0.75rem; text-align: center; color: var(--text-secondary); margin-top: 15px; opacity: 0.5; }

        /* ====== æ¨¡æ€æ¡† (è¯¦æƒ…é¡µ) æ ·å¼ ====== */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px);
            z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #1e293b; width: 90%; max-width: 1000px; height: 90vh;
            border-radius: 15px; border: 1px solid var(--accent-blue);
            box-shadow: 0 0 50px rgba(52, 152, 219, 0.2);
            padding: 30px; display: flex; flex-direction: column;
            overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 15px; }
        .modal-title { font-size: 1.8rem; color: var(--accent-blue); }
        .close-btn { background: none; border: none; color: #fff; font-size: 2rem; cursor: pointer; }
        .close-btn:hover { color: var(--accent-red); }
        
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; flex: 1; }
        .chart-box { background: rgba(15, 23, 42, 0.5); padding: 15px; border-radius: 10px; border: 1px solid #334155; height: 300px; position: relative; }
        .chart-box h4 { margin: 0 0 10px 0; color: var(--text-secondary); text-align: center; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="brand">âš¡ DIGITAL MONITOR HUB</div>
        <div class="user-info">
            <span>OPERATOR: {{ user.id }}</span>
            <a href="{{ url_for('logout') }}" class="btn-logout">å®‰å…¨ç™»å‡º</a>
        </div>
    </nav>

    <div class="container">
        <div id="server-list" class="grid">
            <div style="text-align: center; color: var(--text-secondary); grid-column: 1/-1; padding: 50px;">æ­£åœ¨æœç´¢ä¿¡å·...</div>
        </div>
    </div>

    <div id="detailModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Server Details</div>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <div class="charts-grid">
                <div class="chart-box">
                    <h4>CPU ä½¿ç”¨ç‡ (%)</h4>
                    <canvas id="cpuChart"></canvas>
                </div>
                <div class="chart-box">
                    <h4>å†…å­˜ ä½¿ç”¨ç‡ (%)</h4>
                    <canvas id="ramChart"></canvas>
                </div>
                <div class="chart-box">
                    <h4>ç¡¬ç›˜ ä½¿ç”¨ç‡ (%)</h4>
                    <canvas id="diskChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDetailServer = null; // å½“å‰æ­£åœ¨æŸ¥çœ‹è¯¦æƒ…çš„æœåŠ¡å™¨å
        let charts = {}; // å­˜å‚¨ Chart å®ä¾‹
        let globalData = {}; // å­˜å‚¨æ‰€æœ‰æ•°æ®

        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 }, // å…³é—­æ›´æ–°æ—¶çš„æ•´ä½“é‡ç»˜åŠ¨ç”»ï¼Œä¿ç•™å¹³æ»‘æ•ˆæœ
                scales: {
                    x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } },
                    y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8' } }
                },
                elements: {
                    line: { tension: 0.4, borderWidth: 2, fill: true }, // å¹³æ»‘æ›²çº¿
                    point: { radius: 0, hitRadius: 10 }
                },
                plugins: { legend: { display: false } }
            };

            const createChart = (ctx, color, bgColor) => {
                return new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{ data: [], borderColor: color, backgroundColor: bgColor }] },
                    options: commonOptions
                });
            };

            charts.cpu = createChart(document.getElementById('cpuChart'), '#3498db', 'rgba(52, 152, 219, 0.2)');
            charts.ram = createChart(document.getElementById('ramChart'), '#9b59b6', 'rgba(155, 89, 182, 0.2)');
            charts.disk = createChart(document.getElementById('diskChart'), '#f1c40f', 'rgba(241, 196, 15, 0.2)');
        }

        function openModal(serverName) {
            currentDetailServer = serverName;
            document.getElementById('modalTitle').innerText = `ğŸ“¡ ${serverName} - å®æ—¶ç›‘æ§`;
            document.getElementById('detailModal').style.display = 'flex';
            if (!charts.cpu) initCharts(); // åˆå§‹åŒ–å›¾è¡¨
            updateCharts(); // ç«‹å³æ¸²æŸ“ä¸€æ¬¡
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            currentDetailServer = null;
        }

        function updateCharts() {
            if (!currentDetailServer || !globalData[currentDetailServer]) return;
            
            const history = globalData[currentDetailServer].history || [];
            const labels = history.map(h => h.time);
            const cpuData = history.map(h => h.cpu);
            const ramData = history.map(h => h.ram);
            const diskData = history.map(h => h.disk);

            const updateSingleChart = (chart, labels, data) => {
                chart.data.labels = labels;
                chart.data.datasets[0].data = data;
                chart.update();
            };

            updateSingleChart(charts.cpu, labels, cpuData);
            updateSingleChart(charts.ram, labels, ramData);
            updateSingleChart(charts.disk, labels, diskData);
        }

        function getColor(value) {
            if (value < 60) return '#3498db';
            if (value < 85) return '#f1c40f';
            return '#e74c3c';
        }

        function updateStats() {
            fetch('/api/stats')
                .then(r => { if (r.status === 401) location.reload(); return r.json(); })
                .then(data => {
                    globalData = data; // ä¿å­˜å…¨å±€æ•°æ®ä¾›å¼¹çª—ä½¿ç”¨
                    const list = document.getElementById('server-list');

                    // å¦‚æœå¼¹çª—å¼€ç€ï¼Œæ›´æ–°å›¾è¡¨
                    if (currentDetailServer) updateCharts();

                    if (Object.keys(data).length === 0) {
                        list.innerHTML = '<div style="color:#aaa;text-align:center;grid-column:1/-1;padding:50px">æš‚æ— åœ¨çº¿èŠ‚ç‚¹</div>';
                        return;
                    }

                    // æ¸²æŸ“å¡ç‰‡åˆ—è¡¨ (è¿™é‡Œæˆ‘ä»¬å°½é‡å¤ç”¨ DOM ä»¥å…é—ªçƒï¼Œç®€åŒ–èµ·è§å…ˆé‡ç»˜)
                    // ä¸ºäº†æ€§èƒ½ï¼Œå®é™…ç”Ÿäº§ä¸­åº”è¯¥æ¯”è¾ƒ DOMï¼Œä½†è¿™é‡Œä¸ºäº†ä»£ç ç®€æ´ç›´æ¥é‡ç»˜
                    // æ³¨æ„ï¼šä¸ºäº†ä¸å½±å“æ­£åœ¨æŸ¥çœ‹çš„å¼¹çª—ï¼Œæˆ‘ä»¬åªæ›´æ–°åˆ—è¡¨ï¼Œä¸é‡æ–°ç”Ÿæˆæ•´ä¸ªé¡µé¢
                    
                    // æ„å»º HTML
                    let html = '';
                    for (const [name, s] of Object.entries(data)) {
                        const isOffline = s.status === 'offline';
                        const cpuVal = isOffline ? 0 : s.cpu.toFixed(1);
                        const ramVal = isOffline ? 0 : s.ram.toFixed(1);
                        
                        // ç¦»çº¿çŠ¶æ€å¤„ç†
                        const statusBadge = isOffline ? 
                            `<span class="status-indicator status-offline">ç¦»çº¿</span>` : 
                            `<span class="status-indicator status-online">è¿è¡Œä¸­</span>`;
                        
                        const clickAction = isOffline ? '' : `onclick="openModal('${name}')"`;

                        html += `
                            <div class="card ${isOffline ? 'offline-card' : ''}" ${clickAction}>
                                <div class="header">
                                    <div class="hostname">${name}</div>
                                    ${statusBadge}
                                </div>
                                <div class="stat-row">
                                    <div class="stat-info"><span>CPU</span><span>${cpuVal}%</span></div>
                                    <div class="progress-bg"><div class="progress-bar" style="width:${s.cpu}%; background:${getColor(s.cpu)}"></div></div>
                                </div>
                                <div class="stat-row">
                                    <div class="stat-info"><span>å†…å­˜</span><span>${ramVal}%</span></div>
                                    <div class="progress-bg"><div class="progress-bar" style="width:${s.ram}%; background:${getColor(s.ram)}"></div></div>
                                </div>
                                <div class="click-hint">${isOffline ? 'æ— æ³•è¿æ¥' : 'ğŸ‘† ç‚¹å‡»æŸ¥çœ‹å†å²å›¾è¡¨'}</div>
                            </div>
                        `;
                    }
                    // åªæœ‰å½“æœåŠ¡å™¨åˆ—è¡¨æ•°é‡å‘ç”Ÿå˜åŒ–ï¼Œæˆ–è€…åˆæ¬¡åŠ è½½æ—¶æ‰æ¸…ç©º innerHTML (é˜²æ­¢æ»šåŠ¨æ¡è·³åŠ¨)
                    // ç®€åŒ–ç‰ˆï¼šç›´æ¥æ›¿æ¢
                    if (list.innerHTML !== html && !document.querySelector('.card:hover')) {
                        list.innerHTML = html;
                    } else if (list.innerHTML === '') {
                        list.innerHTML = html;
                    }
                });
        }

        setInterval(updateStats, 2000);
        updateStats();

        // ç‚¹å‡»é®ç½©å…³é—­
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('detailModal')) closeModal();
        });
    </script>
</body>
</html>
